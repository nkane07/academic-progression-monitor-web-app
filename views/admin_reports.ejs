<!DOCTYPE html>
<html>

<head>
    <title>Reports & Statistics</title>
    <link rel="stylesheet" href="https://cdn.simplecss.org/simple.min.css">
    <link rel="stylesheet" href="/styles.css">
</head>

<body>
    <header>
        <h2>Reports</h2>
        <nav>
            <a href="/admin" class="button">Dashboard</a>
            <a href="/logout" class="button">Logout</a>
        </nav>
    </header>

    <main class="container">
        <h3>Module Passes and Average Grades by Pathway</h3>
        <table>
            <thead>
                <tr>
                    <th>Pathway</th>
                    <th>Total Students</th>
                    <th>Modules Passed</th>
                    <th>Average Grade</th>
                </tr>
            </thead>
            <tbody>
                <% stats.pathwayStats.forEach(p=> { %>
                    <tr>
                        <td>
                            <%= p.pathway %>
                        </td>
                        <td>
                            <%= p.total_students %>
                        </td>
                        <td>
                            <%= p.passed_modules %>
                        </td>
                        <td>
                            <%= p.avg_grade ? parseFloat(p.avg_grade).toFixed(2) : 'N/A' %>
                        </td>

                    </tr>
                    <% }) %>
            </tbody>
        </table>

        <h3>Top 5 Most Failed Modules</h3>
        <table>
            <thead>
                <tr>
                    <th>Module</th>
                    <th>Module Name</th>
                    <th>Fail Count</th>
                </tr>
            </thead>
            <tbody>
                <% stats.failedModules.forEach(f=> { %>
                    <tr>
                        <td>
                            <%= f.module_code %>
                        </td>
                        <td>
                            <%= f.module_name %>
                        </td>
                        <td>
                            <%= f.fails %>
                        </td>
                    </tr>
                    <% }) %>
            </tbody>
        </table>

        <h3>Progression Rates by Pathway</h3>

        <form method="get" action="/admin/reports" style="text-align: center; margin-bottom: 1rem;">
            <label for="level">Filter by Academic Year:</label>
            <select name="level" id="level" onchange="this.form.submit()">
                <option value="all" <%=selectedLevel==='all' ? 'selected' : '' %>>All Years</option>
                <option value="1" <%=selectedLevel==='1' ? 'selected' : '' %>>Year 1</option>
                <option value="2" <%=selectedLevel==='2' ? 'selected' : '' %>>Year 2</option>
                <option value="3" <%=selectedLevel==='3' ? 'selected' : '' %>>Year 3</option>
            </select>
        </form>

        <table>
            <thead>
                <tr>
                    <th>Pathway</th>
                    <th>Total Students</th>
                    <th>Progressing</th>
                    <th>Progression Rate</th>
                </tr>
            </thead>
            <tbody>
                <% for (let key in stats.progressionSummary) { const data=stats.progressionSummary[key]; const
                    rate=((data.progressing / data.total) * 100).toFixed(1); %>
                    <tr>
                        <td>
                            <%= key %>
                        </td>
                        <td>
                            <%= data.total %>
                        </td>
                        <td>
                            <%= data.progressing %>
                        </td>
                        <td>
                            <%= rate %>%
                        </td>
                    </tr>
                    <% } %>
            </tbody>
        </table>

        <canvas id="progressionChart" width="600" height="300"></canvas>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
          const ctx = document.getElementById('progressionChart').getContext('2d');
        
          const chart = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: <%- JSON.stringify(Object.keys(stats.progressionSummary)) %>,
              datasets: [{
                label: 'Progression %',
                data: <%- JSON.stringify(Object.values(stats.progressionSummary).map(p =>
                  p.total ? ((p.progressing / p.total) * 100).toFixed(2) : 0
                )) %>,
                backgroundColor: '#3f8efc'
              }]
            },
            options: {
              scales: {
                y: {
                  beginAtZero: true,
                  max: 100
                }
              }
            }
          });
        </script>
        
        </script>


    </main>

    <footer>
        <p>University Portal Â© <%= currentYear %>
        </p>
    </footer>
</body>

</html>